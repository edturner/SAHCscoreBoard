## League Data Pipeline Overview

This document explains how the St Albans League of Leagues dashboard stays up to date. It covers the England Hockey GMS API integrations, JSON snapshot handling, trend calculations, and operational steps for the weekly refresh.

---

### 1. Components at a Glance
- `scripts/gms_fetcher.py`: Python CLI client that talks to the GMS API, exports JSON snapshots, and validates them.
- `config/teamCompIDs.json`: mapping of club teams to their competition IDs (produced by `gms_fetcher.py competitions`).
- `data/league/teamData.json`: “current” snapshot that League of Leagues reads.
- `data/league/teamData.prev.json`: previous snapshot, automatically rolled during weekly updates and used for trend comparisons and fallbacks.
- `apps/league/league.js`: front-end script that renders the League of Leagues table, comparing current vs. previous snapshots to show rank trends.

---

### 2. England Hockey GMS API Integration

`scripts/gms_fetcher.py` wraps the public GMS “refresh” endpoints:

| CLI command | Endpoint | Purpose |
|-------------|----------|---------|
| `competitions` | `https://gmsfeed.co.uk/api/competitions?team=<team>` | Scrapes the competitions dropdown for each club team, persisting `teamId` → `compId`. |
| `team-summary` | `.../show=league` | Parses the “summary” row for a single team (played, won/drawn/lost, points, PPG, form). |
| `bulk-team-data` | same as `team-summary` | Scripted fetch for every team in `teamCompIDs.json`. |
| `recent-results` | `show=results+fixtures` | Pulls last weekend’s fixtures for fixture dashboards. |
| `update-scoreboard`| `show=results+fixtures` | **New**: Fetches full scoreboard data (fixtures/results) for home/away displays. |

API safety measures:
- Client-side rate limiting (default 1200 ms) and automatic retry/backoff when 429s occur.
- Exponential delay escalation using `Retry-After` headers when provided.
- Structured parsers (`HTMLParser` subclasses) to extract table cells, form entries, and league metadata reliably.

---

### 3. Weekly Snapshot Workflow

1. **Prepare config** (only when competitions change):
   ```powershell
   python scripts/gms_fetcher.py competitions `
       --team-file config/teamIDs.json `
       --output config/teamCompIDs.json
   ```

2. **Fetch a fresh snapshot** (typically on Wednesday):
   ```powershell
   python scripts/gms_fetcher.py bulk-team-data `
       --config config/teamCompIDs.json `
       --output data/league/teamData.new.json `
       --publish-path data/league/teamData.json `
       --rotate-snapshots `
       --snapshot-date YYYY-MM-DD
   ```
   - Writes to `data/league/teamData.new.json` when `--output` equals the publish path.
   - On success, rotates: `data/league/teamData.json` → `data/league/teamData.prev.json`, `data/league/teamData.new.json` → `data/league/teamData.json`.
   - If any team still fails after retries, rotation is skipped (prevents incomplete data going live).

3. **Validate snapshots before publishing elsewhere** (optional but recommended):
   ```powershell
   python scripts/gms_fetcher.py validate-snapshots `
       --current data/league/teamData.json `
       --previous data/league/teamData.prev.json `
       --expect-count 26
   ```
   Fails with actionable messages if counts diverge, errors remain, PPG is missing, or teamId sets drift between snapshots.

4. **Deploy/Upload**: once validation passes, sync `data/league/teamData.json` (current) and `data/league/teamData.prev.json` (previous) wherever the website expects them.

---

### 4. Snapshot Rotation & Fallback Logic

- `data/league/teamData.json`: live/current dataset consumed by the front-end.
- `data/league/teamData.prev.json`: previous live dataset (auto-generated by rotation). Needed for:
  - Trend comparison in `league.js`.
  - Fallback source when the API cannot deliver a particular team during the latest fetch.

During `bulk-team-data`:
1. Each team fetch is attempted once, then retried up to `VALIDATION_MAX_RETRIES` (default 2) with incremental `VALIDATION_BACKOFF_SECONDS` delays.
2. If the API still fails but the team existed in the prior snapshot, that previous entry is copied forward with metadata:
   ```json
   "meta": {
     "source": "fallback",
     "fallbackSnapshot": "data/league/teamData.json",
     "fallbackAppliedAt": "2025-11-19T09:12:41Z",
     "snapshotDate": "2025-11-19"
   }
   ```
3. Rotation proceeds only when **no** unresolved errors remain (ensures we never overwrite `data/league/teamData.json` with a degraded dataset).

---

### 5. League Front-End Data Flow (`league.js`)

1. Fetches `data/league/teamData.json` (current) and attempts to fetch `data/league/teamData.prev.json` (previous). If the previous snapshot is missing, all trends default to “steady”.
2. Applies optional gender filter:
   - Uses `(M)` / `(F)` suffixes in `team.name`/`teamDisplay`.
   - Filters out entries with missing or non-numeric PPG.
3. Sorts by PPG (descending) to assign ranks.
4. Builds lookup tables for the previous snapshot:
   - `previousRankMap`: `teamId → position`.
   - `previousLookup`: `teamId → full record`.
5. `determineTrend()` compares current rank and PPG to previous values:
   - Rank improved or same rank with PPG increase → `movement-up` (green badge, ↑ arrow).
   - Rank worsened or same rank with PPG drop beyond a 0.01 tolerance → `movement-down`.
   - Otherwise `movement-steady`.
6. Rows render with consistent UI cues (chip color, table border, arrow icon). Form badges remain derived from the latest five results.

The front-end is resilient: if `data/league/teamData.prev.json` cannot be fetched, it logs a warning and shows neutral arrows rather than breaking the grid.

---

### 6. Operational Checklist

| Step | Command / Action | Notes |
|------|------------------|-------|
| 1 | `python scripts/gms_fetcher.py bulk-team-data ...` | include `--rotate-snapshots`, `--snapshot-date`. |
| 2 | Confirm console summary: “Saved N team records …” and no “Skipping rotation” warning. |
| 3 | `python scripts/gms_fetcher.py validate-snapshots ...` | ensures both current/prev files are healthy. |
| 4 | Upload `data/league/teamData.json` and `data/league/teamData.prev.json` to hosting (keep both!). |
| 5 | Load `leagueOfLeagues-men.html` or `leagueOfLeagues-women.html` in a browser and confirm arrows/ranks look sensible. |

---

### 7. Troubleshooting Tips
- **API rate limits**: if the script repeatedly prints 429 errors, increase the spacing (adjust `GMSClient.rate_limit_ms`) or re-run later; the client already honors `Retry-After`.
- **Persistent missing teams**: inspect the console messages after `bulk-team-data`. If the same team keeps failing, verify its `teamId/compId` in `config/teamCompIDs.json`, or run `python scripts/gms_fetcher.py team-summary --team-id ... --comp-id ...` manually.
- **Fallback usage**: when fallbacks are applied you’ll see: `Used X fallback record(s) from data/league/teamData.json for: ...`. Consider retrying later so fresh data replaces the fallback entries.
- **Trend mismatches**: ensure `data/league/teamData.prev.json` is the **previous week’s** snapshot. If the file was deleted, rerun last week’s snapshot export or temporarily copy the current file so trends show steady arrows until history rebuilds.

---

With this workflow in place, the League of Leagues stays fresh every Wednesday, displays meaningful movement indicators, and degrades gracefully when the GMS API has hiccups. Adjust snapshot timing, retry counts, or validation thresholds as needed for future seasons.
